/**
 *  Neato SDK Javascript
 *  https://github.com/NeatoRobotics/neato-sdk-js
 *
 *  Copyright (c)2016 Neato Robotics, Inc.
 *  Author: Roberto Ostinelli
 *
 *  Version: 0.9.0
 */
var Neato={user:null,Services:{},Constants:{CLEAN_HOUSE_MODE:2,CLEAN_SPOT_MODE:3,MANUAL_CLEANING_MODE:1,ECO_MODE:1,TURBO_MODE:2,SPOT_AREA_SMALL:200,SPOT_AREA_LARGE:400,HOUSE_FREQUENCY_NORMAL:1,HOUSE_FREQUENCY_DOUBLE:2,SPOT_FREQUENCY_NORMAL:1,SPOT_FREQUENCY_DOUBLE:2,EXTRA_CARE_OFF:1,EXTRA_CARE_ON:2}};Neato.utils={haveEqualProps:function(e,t){var n;for(n in e)if("undefined"==typeof t[n])return!1;for(n in e)if(e[n])switch(typeof e[n]){case"object":if(!this.haveEqualProps(e[n],t[n]))return!1;break;case"function":if("undefined"==typeof t[n]||"equals"!=n&&e[n].toString()!=t[n].toString())return!1;break;default:if(e[n]!=t[n])return!1}else if(t[n])return!1;for(n in t)if("undefined"==typeof e[n])return!1;return!0},clone:function(e,t){t=t||{};var n={},r=t.except,a=t.only;for(var i in e)!e.hasOwnProperty(i)||-1!==$.inArray(i,r)||"undefined"!=typeof a&&-1===$.inArray(i,a)||(n[i]=e[i]);return n},isNullOrEmptyJSON:function(e){return null==e?!0:jQuery.isEmptyObject(e)?!0:!1}},Neato.User=function(){this.initialize.apply(this,arguments)},Neato.User.prototype={initialize:function(){this.__parseRedirectURIResponse(),this.host="beehive.neatocloud.com",this.oauthHost="apps.neatorobotics.com",this.robots=[],Neato.user=this},getUserInfo:function(){return this.__call("GET","/users/me")},__getRobotMaps:function(e){return this.__call("GET","/users/me/robots/"+e+"/maps")},__getMapDetails:function(e,t){return this.__call("GET","/users/me/robots/"+e+"/maps/"+t)},getRobots:function(){var e=this,t=$.Deferred();return this.__call("GET","/users/me/robots").done(function(n){e.robots=[];for(var r=0;r<n.length;r++)n[r].linked_at&&e.robots.push(new Neato.Robot(n[r].serial,n[r].secret_key,{name:n[r].name,model:n[r].model}));t.resolve.call(e,e.robots)}).fail(function(n){t.reject.call(e,n)}),t},getRobotBySerial:function(e){for(var t=0;t<this.robots.length;t++)if(0==this.robots[t].serial.localeCompare(e))return this.robots[t];return null},login:function(e){e=e||{};var t="https://"+this.oauthHost+"/oauth2/authorize?client_id="+e.clientId+"&scope="+e.scopes+"&response_type=token&redirect_uri="+e.redirectUrl;this.__navigateToURL(t)},logout:function(){var e=this;return this.__call("POST","/oauth2/revoke",{token:e.token})},isConnected:function(){var e=this,t=$.Deferred();return this.__sessionsCheck().done(function(n){e.connected=!0,t.resolve.call(e,!0)}).fail(function(n){e.connected=!1,t.reject.call(e,!1)}),t},authenticationError:function(){return void 0!=this.authError},__sessionsCheck:function(){return this.__call("GET","/users/me")},__navigateToURL:function(e){location.replace(e)},__parseRedirectURIResponse:function(){var e=document.location.hash.replace("#","").split("&"),t=this;e.forEach(function(e,n){var r=e.split("=")[0]||"",a=e.split("=")[1]||"";0==r.localeCompare("access_token")?t.token=a:0==r.localeCompare("error")?t.authError=a:0==r.localeCompare("error_description")&&(t.authErrorDescription=a.replace(/\+/g," "))})},__call:function(e,t,n){n=0==e.localeCompare("GET")?n||null:n||{};var r=this,a=$.Deferred(),i="https://"+this.host+t,o="application/vnd.neato.beehive.v1+json",s=new Date,c=s.toUTCString(),l=null==n?null:JSON.stringify(n),u="Bearer "+this.token,d=$.ajax({crossDomain:!0,dataType:"json",method:e,url:i,headers:{Accept:o,Authorization:u,"X-Date":c,"Content-type":"application/json"},data:l});return d.done(function(e,t,n){a.resolve.call(r,n.responseJSON)}).fail(function(e,t,n){a.reject.call(r,e.responseJSON)}),a}},Neato.Robot=function(){this.initialize.apply(this,arguments)},Neato.Robot.prototype={initialize:function(e,t,n){this.serial=e,this.secretKey=t,n=n||{},this.host="nucleo.neatocloud.com",this.port=4443,this.onConnected=n.onConnected,this.onDisconnected=n.onDisconnected,this.onStateChange=n.onStateChange,this.name=n.name,this.model=n.model},connect:function(){var e=this;this.timer=setInterval(function(){e.getState.apply(e)},3e3),this.getState()},disconnect:function(){clearInterval(this.timer),delete this.timer,this.__disconnect()},getState:function(){var e={reqId:"1",cmd:"getRobotState"};return this.__call(e)},__call:function(e){var t=this,n=$.Deferred(),r="https://"+this.host+":"+this.port+"/vendors/neato/robots/"+this.serial+"/messages",a="application/vnd.neato.nucleo.v1",i=new Date,o=i.toUTCString(),s=JSON.stringify(e),c=this.serial.toLowerCase()+"\n"+o+"\n"+s,l="NEATOAPP "+CryptoJS.HmacSHA256(c,this.secretKey);return $.ajax({crossDomain:!0,dataType:"json",method:"POST",url:r,headers:{Accept:a,Authorization:l,"X-Date":o},data:s}).done(function(e,r,a){var i=a.responseJSON;t.__setState(i);var o=t.__extractReplyFromReponse(i);"ok"==o.result?n.resolve.call(t,o.result,o.data):n.reject.call(t,o.result,o.data)}).fail(function(e,n,r){t.__disconnect(e.status,e.responseJSON)}),n},__setState:function(e){if("undefined"!=typeof e.state){var t=Neato.utils.clone(e,{except:["version","reqId","result","data"]}),n="undefined"==typeof this.state,r=n||!Neato.utils.haveEqualProps(this.state,t);this.state=t,n&&this.onConnected&&this.onConnected(),r&&this.onStateChange&&(this.onStateChange(),this.__initializeAvailableServices())}},__initializeAvailableServices:function(){for(var e in this.state.availableServices)this.__extend(Neato.Services[e+"_"+this.state.availableServices[e].replace("-","")])},__disconnect:function(e,t){delete this.state,this.onDisconnected&&this.onDisconnected(e,t)},__extractReplyFromReponse:function(e){return Neato.utils.clone(e,{only:["result","data"]})},__extend:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])}},Neato.Robot.extend=function(e){for(var t in e)e.hasOwnProperty(t)&&(Neato.Robot.prototype[t]=e[t])},Neato.Services.cleaning={stopCleaning:function(){var e={reqId:"1",cmd:"stopCleaning"};return this.__call(e)},pauseCleaning:function(){var e={reqId:"1",cmd:"pauseCleaning"};return this.__call(e)},resumeCleaning:function(){var e={reqId:"1",cmd:"resumeCleaning"};return this.__call(e)},sendToBase:function(){var e={reqId:"1",cmd:"sendToBase"};return this.__call(e)}},Neato.Services.houseCleaning_basic1={startHouseCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_HOUSE_MODE,mode:e.mode||Neato.Constants.TURBO_MODE,modifier:e.modifier||Neato.Constants.HOUSE_FREQUENCY_NORMAL}};return this.__call(t)},supportEcoTurboMode:function(){return!0},supportFrequency:function(){return!0},supportExtraCare:function(){return!1},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.houseCleaning_basic2={startHouseCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_HOUSE_MODE,mode:e.mode||Neato.Constants.TURBO_MODE,modifier:e.modifier||Neato.Constants.HOUSE_FREQUENCY_NORMAL,navigationMode:e.navigationMode||Neato.Constants.EXTRA_CARE_OFF}};return this.__call(t)},supportEcoTurboMode:function(){return!0},supportFrequency:function(){return!0},supportExtraCare:function(){return!0},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.houseCleaning_minimal2={startHouseCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_HOUSE_MODE,navigationMode:e.navigationMode||Neato.Constants.EXTRA_CARE_OFF}};return this.__call(t)},supportEcoTurboMode:function(){return!1},supportFrequency:function(){return!1},supportExtraCare:function(){return!0},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.spotCleaning_basic1={startSpotCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_SPOT_MODE,mode:e.mode||Neato.Constants.TURBO_MODE,modifier:e.modifier||Neato.Constants.HOUSE_FREQUENCY_NORMAL,spotWidth:e.spotWidth||Neato.Constants.SPOT_AREA_LARGE,spotHeight:e.spotHeight||Neato.Constants.SPOT_AREA_LARGE}};return this.__call(t)},supportEcoTurboMode:function(){return!0},supportFrequency:function(){return!0},supportExtraCare:function(){return!1},supportArea:function(){return!0},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.spotCleaning_basic2={startSpotCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_SPOT_MODE,mode:e.mode||Neato.Constants.TURBO_MODE,modifier:e.modifier||Neato.Constants.HOUSE_FREQUENCY_NORMAL,spotWidth:e.spotWidth||Neato.Constants.SPOT_AREA_LARGE,spotHeight:e.spotHeight||Neato.Constants.SPOT_AREA_LARGE,navigationMode:e.navigationMode||Neato.Constants.EXTRA_CARE_OFF}};return this.__call(t)},supportEcoTurboMode:function(){return!0},supportFrequency:function(){return!0},supportExtraCare:function(){return!0},supportArea:function(){return!0},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.spotCleaning_micro2={startSpotCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_SPOT_MODE,navigationMode:e.navigationMode||Neato.Constants.EXTRA_CARE_OFF}};return this.__call(t)},supportEcoTurboMode:function(){return!1},supportFrequency:function(){return!1},supportExtraCare:function(){return!0},supportArea:function(){return!1},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.spotCleaning_minimal2={startSpotCleaning:function(e){e=e||{};var t={reqId:"1",cmd:"startCleaning",params:{category:Neato.Constants.CLEAN_SPOT_MODE,modifier:e.modifier||Neato.Constants.HOUSE_FREQUENCY_NORMAL,navigationMode:e.navigationMode||Neato.Constants.EXTRA_CARE_OFF}};return this.__call(t)},supportEcoTurboMode:function(){return!1},supportFrequency:function(){return!0},supportExtraCare:function(){return!0},supportArea:function(){return!1},stopCleaning:Neato.Services.cleaning.stopCleaning,pauseCleaning:Neato.Services.cleaning.pauseCleaning,resumeCleaning:Neato.Services.cleaning.resumeCleaning,sendToBase:Neato.Services.cleaning.sendToBase},Neato.Services.findMe_basic1={findMe:function(){var e={reqId:"1",cmd:"findMe"};return this.__call(e)}},Neato.Services.generalInfo_advanced1={generalInfo:function(){var e={reqId:"1",cmd:"getGeneralInfo"};return this.__call(e)}},Neato.Services.generalInfo_basic1={generalInfo:function(){var e={reqId:"1",cmd:"getGeneralInfo"};return this.__call(e)}},Neato.Services.localStats_advanced1={localStats:function(){var e={reqId:"1",cmd:"getLocalStats"};return this.__call(e)}},Neato.Services.maps_basic1={maps:function(){return Neato.user.__getRobotMaps(this.serial)},mapDetails:function(e){return Neato.user.__getMapDetails(this.serial,e)}},Neato.Services.preferences_advanced1={getPreferences:function(){var e={reqId:"1",cmd:"getPreferences"};return this.__call(e)},setPreferences:function(e){e=e||{};var t={reqId:"1",cmd:"setPreferences",params:{robotSounds:e.robotSounds||!1,dirtbinAlert:e.dirtbinAlert||!1,allAlerts:e.allAlerts||!1,leds:e.leds||!1,buttonClicks:e.buttonClicks||!1,dirtbinAlertReminderInterval:e.dirtbinAlertReminderInterval||150,filterChangeReminderInterval:e.filterChangeReminderInterval||43200,brushChangeReminderInterval:e.brushChangeReminderInterval||172800,clock24h:e.clock24h||!1,locale:e.locale||"en"}};return this.__call(t)}},Neato.Services.preferences_basic1={getPreferences:function(){var e={reqId:"1",cmd:"getPreferences"};return this.__call(e)},setPreferences:function(e){e=e||{};var t={reqId:"1",cmd:"setPreferences",params:{dirtbinAlertReminderInterval:e.dirtbinAlertReminderInterval||150,filterChangeReminderInterval:e.filterChangeReminderInterval||43200,brushChangeReminderInterval:e.brushChangeReminderInterval||172800}};return this.__call(t)}},Neato.Services.schedule_basic1={setSchedule:function(e){e=e||{};var t=$.map(e,function(e,t){return{mode:e.mode||Neato.Constants.TURBO_MODE,day:parseInt(t,10),startTime:e.startTime}}),n={reqId:"1",cmd:"setSchedule",params:{type:1,events:t}};return this.__call(n)},getSchedule:function(){var e={reqId:"1",cmd:"getSchedule"};return this.__call(e)},enableSchedule:function(){var e={reqId:"1",cmd:"enableSchedule"};return this.__call(e)},disableSchedule:function(){var e={reqId:"1",cmd:"disableSchedule"};return this.__call(e)}},Neato.Services.schedule_minimal1={setSchedule:function(e){e=e||{};var t=$.map(e,function(e,t){return{day:parseInt(t,10),startTime:e.startTime}}),n={reqId:"1",cmd:"setSchedule",params:{type:1,events:t}};return this.__call(n)},getSchedule:function(){var e={reqId:"1",cmd:"getSchedule"};return this.__call(e)},enableSchedule:function(){var e={reqId:"1",cmd:"enableSchedule"};return this.__call(e)},disableSchedule:function(){var e={reqId:"1",cmd:"disableSchedule"};return this.__call(e)}},Neato.Services.wifi_basic1={getWifiNetworks:function(){var e={reqId:"1",cmd:"getWifiNetworks"};return this.__call(e)},setWifiNetwork:function(e){e=e||{};var t={reqId:"1",cmd:"setWifiNetwork",params:{ssid:e.ssid||""}};return this.__call(t)},addWifiNetwork:function(e){e=e||{};var t={reqId:"1",cmd:"addWifiNetwork",params:{ssid:e.ssid||"",password:e.password||""}};return this.__call(t)},removeWifiNetwork:function(e){e=e||{};var t={reqId:"1",cmd:"removeWifiNetwork",params:{ssid:e.ssid||""}};return this.__call(t)},getAvailableWifiNetworks:function(){var e={reqId:"1",cmd:"getAvailableWifiNetworks"};return this.__call(e)},resetWifiNetworks:function(){var e={reqId:"1",cmd:"resetWifiNetworks"};return this.__call(e)}};